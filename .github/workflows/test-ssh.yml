name: Check SSH credentials

on:
  pull_request:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_PASSPHRASE: ${{ secrets.SSH_PASSPHRASE }}
          SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
        run: |
          # Start the ssh-agent
          eval $(ssh-agent -s)
          
          # Create a temporary file for the expect script
          cat <<EOF > add_key.sh
          #!/usr/bin/expect -f
          spawn ssh-add -
          expect "Enter passphrase for /dev/stdin:"
          send "\$env(SSH_PASSPHRASE)\r"
          expect eof
          EOF
          chmod +x add_key.sh
          
          # Add the private key to the ssh-agent
          echo "$SSH_PRIVATE_KEY" | ./add_key.sh
          
          # Optional: Add the server's host key to known_hosts to avoid interactive prompts
          mkdir -p ~/.ssh
          ssh-keyscan projects-storage.eclipse.org >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: ‚úÖ Check SSH credentials
        shell: bash
        run: |
          echo "üîç Testing SSH access..."
          ssh -o StrictHostKeyChecking=yes $env(SSH_USERNAME)@projects-storage.eclipse.org \
            "test -d /home/data/httpd/download.eclipse.org/keypop && echo '‚úÖ Access OK' || echo '‚ùå Access Denied'"
