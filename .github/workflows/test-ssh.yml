name: Check SSH credentials

on:
  pull_request:
    branches: [main]

jobs:
  check-ssh:
    runs-on: ubuntu-latest
    steps:
      - name: Set up SSH key and debug
        shell: bash
        run: |
          echo "üîê Setting up SSH directory"
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          echo "üîê Writing SSH private key"
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          echo "üîê Starting ssh-agent"
          eval "$(ssh-agent -s)"

          echo "üîê Adding SSH key with ssh-add"
          echo "Note: ssh-add will fail if the key requires a passphrase and no agent interaction is possible."

          # Try with SSH_ASKPASS fallback to echo for debugging (non-interactive env)
          export DISPLAY=:0
          SSH_ASKPASS="$(which echo)" SSH_ASKPASS_REQUIRE=force ssh-add ~/.ssh/id_rsa || {
            echo "‚ùå ssh-add failed ‚Äî likely due to passphrase. Try using an unencrypted key or configure SSH agent forwarding."
            exit 1
          }

          echo "‚úÖ ssh-add succeeded"

          echo "üîê Known hosts setup"
          ssh-keyscan -H projects-storage.eclipse.org >> ~/.ssh/known_hosts
          
          echo "üîê SSH config (optional)"
          echo -e "Host projects-storage.eclipse.org\n\tStrictHostKeyChecking no\n" >> ~/.ssh/config
          chmod 600 ~/.ssh/config

      - name: Check SSH connectivity
        shell: bash
        run: |
          echo "üîó Testing SSH connection..."
          ssh -v genie.keypop@projects-storage.eclipse.org "echo '‚úÖ SSH connection successful'" || {
            echo "‚ùå SSH connection failed"
            exit 1
          }
